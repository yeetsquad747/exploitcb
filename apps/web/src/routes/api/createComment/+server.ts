import { PrismaClient } from '@prisma/client';
import { json } from '@sveltejs/kit';
import jwt, { type JwtPayload } from 'jsonwebtoken';
import Ajv, { type JSONSchemaType } from 'ajv';

const ajv = new Ajv();
const prisma = new PrismaClient();

interface Data {
  token: string;
  content: string;
  post_id: number;
}

const schema: JSONSchemaType<Data> = {
  type: 'object',
  properties: {
    content: { type: 'string' },
    token: { type: 'string' },
    post_id: { type: 'number' }
  },
  required: ['content', 'token', 'post_id']
};

const validate = ajv.compile(schema);

/**
 * Function to handle POST requests to /api/createComment
 * @param params The request parameters
 * @returns A response to the request
 */
export async function POST(params: {
  request: { json: () => { content: string; token: string; post_id: number } };
}) {
  const data = await params.request.json();
  const decodeToken = jwt.decode(data.token);
  if (typeof decodeToken === 'string') {
    return await json('Invalid token');
  }
  if (validate(data)) {
    return await json(validate.errors);
  }
  const user = await prisma.user.findUnique({
    where: {
      user_id: decodeToken?.id
    }
  });
  if (!user) {
    return await json('Invalid token');
  }
  let tokenIsValid = false;
  try {
    // @ts-ignore
    tokenIsValid = jwt.verify(data.token, String(process.env.JWT_KEY));
  } catch (error) {
    return await json('Invalid token');
  }
  if (tokenIsValid) {
    const id = Math.floor(Math.random() * 10000000000000000);
    try {
      await prisma.comment.create({
        data: {
          comment_id: id,
          // @ts-ignore
          body: data.content,
          user: {
            connect: {
              // @ts-ignore
              user_id: jwt.decode(data.token).id
            }
          },
          post: {
            connect: {
              // @ts-ignore
              post_id: data.post_id
            }
          }
        }
      });
    } catch {
      return await json('Something went wrong, try that again');
    }
    return await json({ id });
  }
}
