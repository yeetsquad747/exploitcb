import { PrismaClient } from '@prisma/client';
import { json } from '@sveltejs/kit';
import type { JSONSchemaType } from 'ajv';
import Ajv from 'ajv';
import jwt, { type JwtPayload } from 'jsonwebtoken';

const ajv = new Ajv();
const prisma = new PrismaClient();

interface Data {
  token: string;
  title: string;
  content: string;
}

const schema: JSONSchemaType<Data> = {
  type: 'object',
  properties: {
    title: { type: 'string' },
    content: { type: 'string' },
    token: { type: 'string' }
  },
  required: ['title', 'content', 'token']
};

const validate = ajv.compile(schema);

/**
 * Function to handle POST requests to /api/createPost
 * @param params The request parameters
 * @returns A response to the request
 */
export async function POST(params: {
  request: { json: () => { title: string; content: string; token: string } };
}) {
  const data = await params.request.json();
  let token: JwtPayload | string = { id: null };
  jwt.verify(data.token, String(process.env.JWT_KEY), (err, decoded) => {
    if (err || decoded === undefined) {
      return json('Invalid token');
    }
    token = decoded;
    return null;
  });
  if (!validate(data)) {
    return await json(validate.errors);
  }
  const user = await prisma.user.findUnique({
    where: {
      user_id: token.id
    }
  });
  if (!user) {
    return await json('Invalid token');
  }
  const id = Math.floor(Math.random() * 10000000000000000);
  try {
    await prisma.post.create({
      data: {
        post_id: id,
        title: data.title,
        body: data.content,
        comments: {},
        user: {
          connect: {
            user_id: token.id
          }
        }
      }
    });
  } catch {
    return await json('Something went wrong, try that again');
  }
  return await json({
    id
  });
}
