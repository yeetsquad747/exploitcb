import { PrismaClient } from '@prisma/client';
import { json } from '@sveltejs/kit';
import type { JSONSchemaType } from 'ajv';
import Ajv from 'ajv';
import jwt, { type JwtPayload } from 'jsonwebtoken';

const ajv = new Ajv();
const prisma = new PrismaClient();

interface Data {
  token: string;
  post_id: number;
}

const schema: JSONSchemaType<Data> = {
  type: 'object',
  properties: {
    post_id: { type: 'number' },
    token: { type: 'string' }
  },
  required: ['token', 'post_id']
};

const validate = ajv.compile(schema);

/**
 * Function to handle DELETE requests to /api/deletePost
 * @param params The request parameters
 * @returns A response to the request
 */
export async function DELETE(params: {
  request: {
    json: () => {
      post_id: number;
      token: string;
    };
  };
}) {
  const data = await params.request.json();
  if (!validate(data)) {
    return await json(validate.errors);
  }
  let token: JwtPayload | string = { id: null };
  jwt.verify(data.token, String(process.env.JWT_KEY), (err, decoded) => {
    if (err || decoded === undefined) {
      return json('Invalid token');
    }
    token = decoded;
    return null;
  });
  const post = await prisma.post.findUnique({
    where: {
      post_id: data.post_id
    }
  });

  if (post?.user_id === token.id) {
    await prisma.comment.deleteMany({
      where: {
        post_id: data.post_id
      }
    });
    await prisma.post.delete({
      where: {
        post_id: data.post_id
      }
    });
    return await json('Deleted post');
  }
  return await json('There was an error in deleting the post');
}
