import { json } from '@sveltejs/kit';
import type { JSONSchemaType } from 'ajv';
import Ajv from 'ajv';
import { PrismaClient } from '@prisma/client';
import { hash } from 'argon2';
import validator from 'validator';
import { v4 as uuidv4 } from 'uuid';
import { verify } from 'hcaptcha';

const ajv = new Ajv();
const prisma = new PrismaClient();

interface Data {
  username: string;
  password: string;
  email: string;
  handle: string;
  token: string;
}

const schema: JSONSchemaType<Data> = {
  type: 'object',
  properties: {
    email: { type: 'string' },
    password: { type: 'string' },
    username: { type: 'string' },
    handle: { type: 'string' },
    token: { type: 'string' }
  },
  required: ['username', 'password', 'email', 'handle', 'token'],
  additionalProperties: true
};

const validate = ajv.compile(schema);

/**
 * Function to validate captcha token
 * @param secret The HCAPTCHA secret
 * @param token The token generated by the user
 * @returns Whether the token is valid or not
 */
async function validateCaptcha(secret: string, token: string) {
  let result = false;
  await verify(secret, token).then((data) => {
    result = data.success;
  });
  return result;
}
/**
 * Function to handle POST requests to /api/register
 * @param params The request parameters
 * @returns A response to the request
 */
export async function POST(params: {
  request: {
    json: () => {
      email: string;
      token: string;
      password: string;
      handle: string;
      username: string;
    };
  };
}) {
  const data = await params.request.json();
  if (!validate(data)) {
    return await json(validate.errors);
  } else if (!validator.isEmail(data.email)) {
    return await json('Please send a valid email');
  } else if (data.handle === '') {
    return await json('Please send a valid handle');
  } else if (!(await validateCaptcha(String(process.env.HCAPTCHA_SECRET), data.token))) {
    return await json('Please verify captcha');
  }
  const hashedPassword = await hash(data.password).catch(async () => {
    return await json('There was an error');
  });
  const id = uuidv4();
  let user = await prisma.user.findUnique({
    where: {
      user_id: id
    }
  });
  if (user) {
    return await json('Please try again');
  }

  user = await prisma.user.findUnique({
    where: {
      email: data.email
    }
  });

  if (user) {
    return await json('Email already in use');
  }

  user = await prisma.user.findUnique({
    where: {
      handle: data.handle
    }
  });

  if (user) {
    return await json('Handle is already in use');
  }
  await prisma.user.create({
    data: {
      email: data.email,
      username: data.username,
      password: String(hashedPassword),
      user_id: id,
      handle: data.handle,
      posts: {},
      comments: {}
    }
  });
  return await json('Success');
}
